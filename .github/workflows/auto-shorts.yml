name: Multi-YouTuber Auto Shorts

on:
  schedule:
    # 毎日 12:00 JST (03:00 UTC) に実行
    - cron: '0 3 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  process-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 最大2時間

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create credentials directory
        run: mkdir -p credentials

      - name: Set up Google Service Account credentials
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          cat > /tmp/create_service_account.py << 'PYTHON_SCRIPT'
          import json
          import os
          import sys
          import re

          json_str = os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON')
          if not json_str:
              print('Error: GOOGLE_SERVICE_ACCOUNT_JSON is not set', file=sys.stderr)
              sys.exit(1)

          # Remove control characters
          json_str_cleaned = ''.join(
              c if (ord(c) >= 32 or c in '\n\t\r') else ' '
              for c in json_str
          )

          # Parse JSON
          try:
              json_data = json.loads(json_str_cleaned)
          except json.JSONDecodeError as parse_error:
              print(f'Error: Invalid JSON - {parse_error}', file=sys.stderr)
              sys.exit(1)

          # Fix private_key format
          if 'private_key' in json_data:
              private_key = json_data['private_key']
              private_key = private_key.replace('-----BEGINPRIVATEKEY-----', '-----BEGIN PRIVATE KEY-----')
              private_key = private_key.replace('-----BEGIN PRIVATEKEY-----', '-----BEGIN PRIVATE KEY-----')
              private_key = private_key.replace('-----ENDPRIVATEKEY-----', '-----END PRIVATE KEY-----')
              private_key = private_key.replace('-----END PRIVATEKEY-----', '-----END PRIVATE KEY-----')

              if '\\\\n' in private_key:
                  private_key = private_key.replace('\\\\n', '\n')
              elif '\\n' in private_key:
                  private_key = private_key.replace('\\n', '\n')

              json_data['private_key'] = private_key

          with open('service-account.json', 'w', encoding='utf-8') as f:
              json.dump(json_data, f, indent=2, ensure_ascii=False)

          print('service-account.json created successfully')
          PYTHON_SCRIPT
          python3 /tmp/create_service_account.py
          chmod 600 service-account.json

      - name: Create .env file
        env:
          DRIVE_OUTPUT_FOLDER_ID: ${{ secrets.DRIVE_OUTPUT_FOLDER_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
        run: |
          cat > .env << EOF
          # ===========================================
          # Multi-YouTuber Auto Shorts System
          # ===========================================

          # API認証（GitHub Actionsでは不要）
          MAKE_SHARED_SECRET=not_used_in_actions

          # Google API設定
          GOOGLE_APPLICATION_CREDENTIALS=./service-account.json
          GEMINI_API_KEY=${GEMINI_API_KEY}

          # Google Drive設定
          DRIVE_OUTPUT_FOLDER_ID=${DRIVE_OUTPUT_FOLDER_ID}

          # Google Sheets設定
          SPREADSHEET_ID=${SPREADSHEET_ID}
          SHEET_YOUTUBERS=YouTubers
          SHEET_UPLOAD_LOG=UploadLog

          # YouTube OAuth設定
          YOUTUBE_CLIENT_ID=${YOUTUBE_CLIENT_ID}
          YOUTUBE_CLIENT_SECRET=${YOUTUBE_CLIENT_SECRET}

          # Whisper設定
          WHISPER_MODEL=small
          WHISPER_DEVICE=cpu
          WHISPER_COMPUTE_TYPE=int8

          # Gemini LLM設定
          GEMINI_MODEL=gemini-2.0-flash

          # ジョブ管理
          MAX_CONCURRENT_JOBS=3
          TMP_DIR=./runout

          # タイムアウト設定（秒）
          DOWNLOAD_TIMEOUT=600
          TRANSCRIBE_TIMEOUT=1800
          RENDER_TIMEOUT=600
          UPLOAD_TIMEOUT=600

          # リトライ設定
          MAX_RETRIES=3
          RETRY_BACKOFF_BASE=2.0

          # バージョン情報
          GIT_SHA=${GITHUB_SHA}
          EOF

      - name: Create output directory
        run: mkdir -p runout

      - name: Run Multi-YouTuber scheduler
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service-account.json
        run: python -m app.multi_scheduler

      - name: Upload generated shorts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shorts-${{ github.run_id }}
          path: |
            runout/*.mp4
            runout/*.srt
          if-no-files-found: ignore
          retention-days: 7
