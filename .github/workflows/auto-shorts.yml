name: Auto Shorts Scheduler

on:
  schedule:
    # 毎日 12:00 JST (03:00 UTC) に実行
    - cron: '0 3 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  process-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 最大2時間

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create credentials directory
        run: mkdir -p credentials

      - name: Set up Google Service Account credentials
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > service-account.json

      - name: Set up YouTube client secret
        env:
          YOUTUBE_CLIENT_SECRET_JSON: ${{ secrets.YOUTUBE_CLIENT_SECRET_JSON }}
        run: |
          echo "$YOUTUBE_CLIENT_SECRET_JSON" > credentials/youtube-client-secret.json

      - name: Set up YouTube token
        env:
          YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
        run: |
          echo "$YOUTUBE_TOKEN_JSON" > credentials/youtube-token.json

      - name: Create .env file
        env:
          MAKE_SHARED_SECRET: ${{ secrets.MAKE_SHARED_SECRET }}
          DRIVE_INPUT_FOLDER_ID: ${{ secrets.DRIVE_INPUT_FOLDER_ID }}
          DRIVE_READY_FOLDER_ID: ${{ secrets.DRIVE_READY_FOLDER_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: |
          cat > .env << EOF
          # API認証
          MAKE_SHARED_SECRET=${MAKE_SHARED_SECRET}

          # Google Drive設定
          GOOGLE_APPLICATION_CREDENTIALS=./service-account.json
          DRIVE_INPUT_FOLDER_ID=${DRIVE_INPUT_FOLDER_ID}
          DRIVE_READY_FOLDER_ID=${DRIVE_READY_FOLDER_ID}

          # Whisper設定
          WHISPER_MODEL=small
          WHISPER_DEVICE=cpu
          WHISPER_COMPUTE_TYPE=int8

          # Gemini設定
          GEMINI_API_KEY=${GEMINI_API_KEY}
          GEMINI_MODEL=gemini-1.5-flash

          # Google Sheets設定
          SPREADSHEET_ID=${SPREADSHEET_ID}

          # ジョブ管理
          MAX_CONCURRENT_JOBS=3

          # 一時ファイルディレクトリ
          TMP_DIR=./runout

          # タイムアウト設定（秒）
          DOWNLOAD_TIMEOUT=600
          TRANSCRIBE_TIMEOUT=1800
          RENDER_TIMEOUT=600
          UPLOAD_TIMEOUT=600

          # リトライ設定
          MAX_RETRIES=3
          RETRY_BACKOFF_BASE=2.0

          # バージョン情報
          GIT_SHA=${GITHUB_SHA}
          EOF

      - name: Create output directory
        run: mkdir -p runout

      - name: Run scheduler
        run: python -m app.scheduler

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: logs
          path: |
            runout/*.log
            runout/*.txt
          retention-days: 7
