name: noteè‡ªå‹•è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ 

on:
  schedule:
    # æ¯æ—¥ 09:00 (JST) ã«å®Ÿè¡Œ
    # UTCæ™‚é–“ã§æŒ‡å®šï¼ˆJSTã¯UTC+9ãªã®ã§ã€00:00 = 09:00 JSTï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  track-note-stats:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd tools
        pip install -r requirements.txt

    - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
      env:
        NOTE_CONFIG_JSON: ${{ secrets.NOTE_CONFIG_JSON }}
        GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      run: |
        cd tools

        # config.jsonã®ä½œæˆ
        if [ -n "$NOTE_CONFIG_JSON" ]; then
          echo "$NOTE_CONFIG_JSON" > config.json
          echo "âœ… config.jsonã‚’ä½œæˆã—ã¾ã—ãŸ"
        else
          echo "âš ï¸ Secret 'NOTE_CONFIG_JSON' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          # config.jsonãŒãªã„ã¨å‹•ã‹ãªã„å ´åˆã¯ã“ã“ã§ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
          # exit 1
        fi

        # google-credentials.jsonã®ä½œæˆï¼ˆå¿…è¦ãªå ´åˆï¼‰
        if [ -n "$GOOGLE_CREDENTIALS_JSON" ]; then
          echo "$GOOGLE_CREDENTIALS_JSON" > google-credentials.json
          echo "âœ… google-credentials.jsonã‚’ä½œæˆã—ã¾ã—ãŸ"
        fi

        # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        ls -la config.json || echo "config.json is missing"

    - name: noteçµ±è¨ˆæƒ…å ±ã‚’å–å¾—
      run: |
        cd tools
        python note-auto-tracker.py --once --config config.json
      continue-on-error: true

    - name: å–å¾—ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
      if: always()
      run: |
        echo "=== å–å¾—ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª ==="
        if [ -f "tools/data/sakueduken_stats_"*.json ]; then
          echo "ğŸ“„ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹:"
          cat tools/data/sakueduken_stats_*.json | head -50
          echo ""
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:"
          ls -lh tools/data/sakueduken_stats_*.json
        else
          echo "âš ï¸ JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

    - name: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºèª
      run: |
        cd tools
        ls -la data/ || echo "dataãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        find data -name "*.json" -type f || echo "JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

    - name: ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆArtifactsï¼‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: note-stats-${{ github.run_number }}
        path: tools/data/
        retention-days: 30
        if-no-files-found: warn

    - name: å®Ÿè¡Œçµæœã®ç¢ºèª
      if: always()
      run: |
        echo "=== å®Ÿè¡Œçµæœã®ç¢ºèª ==="
        if [ -d "tools/data" ] && [ -n "$(find tools/data -name '*.json' -type f)" ]; then
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          find tools/data -name "*.json" -type f
          echo ""
          echo "ğŸ’¡ ãƒ‡ãƒ¼ã‚¿ã¯Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™"
          echo "   GitHub Actionsã®å®Ÿè¡Œå±¥æ­´ â†’ Artifacts ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"
        else
          echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

